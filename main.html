<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>夕食ロボ</title>
</head>
<body>

  <header>
    <h2 class="title">夕食ロボ</h1>
    <nav class="nav">
      <ul class="menu-group">
        <li class="menu-item"><input type="submit" value="ガチャ" class="page_gacha"></li>
        <li class="menu-item"><input type="submit" value="履歴" class="page_history"></li>
        <li class="menu-item"><input type="submit" value="料理追加" class="page_add"></li>
        <li class="menu-item"><input type="submit" value="料理一覧" class="page_index"></li>
        <li class="menu-item"><input type="submit" value="サイトについて" class="page_help"></li>
      </ul>
    </nav>
  </header>

  <main>

    <div class="contents_gacha"></div>
    <div class="contents_history"></div>
    <div class="contents_add"></div>
    <div class="contents_index"></div>
    <div class="contents_help"></div>

  </main>
</body>
<style>
  header {
  display: flex;
  width: 100%;
  height: 100px;
  background-color: lightblue;
  align-items: center;
  }
  
  .title {
    margin-right: auto;
  }
  
  .menu-item {
    list-style: none;
    display: inline-block;
    padding: 10px;
  }

</style>
<script>

  //Delete_history();
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const date = now.getDate();
  const YYYYMMDD = `${year}/${month}/${date}`;
  const weekday = now.toLocaleDateString('ja', {weekday: 'long'});
  let kinds = 0;

  const N_kind = 3;
  const N_difficulty = 3;
  const N_feature = 5;
  const N_ingredient = 3;

  class Meal{
    constructor(id,name,memo,kind,difficulty,feature,ingredient){
      this.id = id;
      this.name = name;
      this.memo = memo;
      this.kind = kind;
      this.difficulty = difficulty;
      this.feature = feature;
      this.ingredient = ingredient;
      kinds++;
      console.log("コンストラクタ呼び出し："+this.id+":"+this.name);
    }
  }

  let meals = new Array(0);

  function Add_meal(id,name,memo,kind,difficulty,feature,ingredient){
    meals.push(new Meal(id,name,memo,kind,difficulty,feature,ingredient));
  }

  // *********************************************
  /*
    テストデータ
  */

  Add_meal(
    0,
    "焼き鳥丼",
    "焼き鳥はタレより塩派。",
    [1,0,0],
    [0,1,0],
    [0,0,0,0,0],
    [0,0,1]
  );

  Add_meal(
    1,
    "ホイコーロー",
    "辛くておいしい。",
    [0,0,1],
    [0,1,0],
    [0,0,0,0,0],
    [0,0,1]
  );

  Add_meal(
    2,
    "シチュー",
    "シチューは洋食だよ。",
    [0,1,0],
    [1,1,1],
    [0,0,0,0,0],
    [0,1,1]
  );
  // *********************************************
  
  let json = localStorage.getItem('results');
  results = JSON.parse(json);
  if(results == null) results = [];

  const set_kinds = document.getElementsByName("kind");
  const set_difficulty = document.getElementsByName("difficulty");

  Show_gacha();

  

  document.querySelector(".page_gacha").addEventListener("click",function(){
    Show_gacha();
  })
  document.querySelector(".page_history").addEventListener("click",function(){
    Show_history();
  })
  document.querySelector(".page_add").addEventListener("click",function(){
    Show_add();
  })
  document.querySelector(".page_index").addEventListener("click",function(){
    Show_index();
  })
  document.querySelector(".page_help").addEventListener("click",function(){
    Show_help();
  })


  function Show_gacha(){
    Delete_page();

    document.querySelector(".contents_gacha").innerHTML = 
    `
    <p>今日は <span class="date_today"></span></p>
    <fieldset>
        <legend>種類(必須)</legend>
        <label><input data-index="1" type="checkbox" name="kind" checked>和食</label>
        <label><input data-index="2" type="checkbox" name="kind" checked>洋食</label>
        <label><input data-index="3" type="checkbox" name="kind" checked>中華</label>
    </fieldset>
    <fieldset>
        <legend>大変さ(必須)</legend>
        <label><input data-index="1" type="checkbox" name="difficulty" checked>簡単</label>
        <label><input data-index="2" type="checkbox" name="difficulty" checked>お手軽</label>
        <label><input data-index="3" type="checkbox" name="difficulty" checked>本格</label>
    </fieldset>
    <fieldset>
        <legend>特徴</legend>
        <label><input data-index="1" type="checkbox" name="feature" >軽め</label>
        <label><input data-index="2" type="checkbox" name="feature" >重め</label>
        <label><input data-index="3" type="checkbox" name="feature" >特別</label>
        <label><input data-index="4" type="checkbox" name="feature" >弁当にプラス</label>
        <label><input data-index="5" type="checkbox" name="feature" >明日も食べられる</label>
    </fieldset>
    <fieldset>
        <legend>\"使わない\"材料</legend>
        <label><input data-index="1" type="checkbox" name="ingredient" >卵</label>
        <label><input data-index="2" type="checkbox" name="ingredient" >牛乳</label>
        <label><input data-index="3" type="checkbox" name="ingredient" >お米</label>
    </fieldset>

      <button class="gacha">ガチャを回す</button>

      <div class="result"></div>
    `;

    document.querySelector(".date_today").textContent = YYYYMMDD + " " + weekday;
    document.querySelector(".gacha").addEventListener("click", function () {
      let flag = false;
      let meals_processed = new Array(0);
      for(let i = 0; i < meals.length; i++){
        let ok = true;
        let flag = false;
        for(let j = 0; j < meals[i].kind.length; j++){
          let elems = document.getElementsByName("kind");
          if(elems[j].checked && meals[i].kind[j] == 1) flag = true;
        }
        if(flag == false) ok = false;
        flag = false;
        for(let j = 0; j < meals[i].difficulty.length; j++){
          let elems = document.getElementsByName("difficulty");
          if(elems[j].checked && meals[i].difficulty[j] == 1) flag = true;
        }
        if(flag == false) ok = false;
        for(let j = 0; j < meals[i].feature.length; j++){
          let elems = document.getElementsByName("feature");
          if(elems[j].checked && meals[i].feature[j] == 0) ok = false;
        }
        for(let j = 0; j < meals[i].ingredient.length; j++){
          let elems = document.getElementsByName("ingredient");
          if(elems[j].checked && meals[i].ingredient[j] == 1) ok = false;
        }

        if(ok){
          meals_processed.push(meals[i]);
        }
      }
      if(meals_processed.length == 0){
        alert("一致する料理がありません...");
      }
      else{
        let r = Math.floor( Math.random() * meals_processed.length );

        document.querySelector(".result").innerHTML = "今日の夕飯は...<br>";
        document.querySelector(".result").innerHTML += "<h2>＼" + meals_processed[r].name +"／</h2><br>";
        document.querySelector(".result").innerHTML += meals_processed[r].memo;

        document.querySelector(".gacha").textContent = `もう一度回す`;
        document.querySelector(".result").innerHTML += `<br><input type="submit" value="これに決定！" class="decide">`;

        document.querySelector(".decide").addEventListener("click",function(){

          if (window.localStorage) {
            results.push(meals_processed[r].id);
            console.log(results);
            let json = JSON.stringify(results, undefined, 1);
            localStorage.setItem('results', json);
            console.log(results);
          }

          // window.close();

        },false);

      }
      
    }, false);


  }


  function Show_history(){
    Delete_page();
    document.querySelector(".contents_history").innerHTML = `<h1>履歴</h1> <ul>`;
    console.log(results);
    for(let i = results.length-1;i >= 0;i--){
      document.querySelector(".contents_history").innerHTML += `<li>${meals[results[i]].name}</li>`
    }
    document.querySelector(".contents_history").innerHTML += `</ul>`;
    document.querySelector(".contents_history").innerHTML +=
    `
    <button class="reset_history">履歴削除</button>
    `;

    document.querySelector(".reset_history").addEventListener("click",function(){
      Delete_history();
      Show_history();
    });
  }


  function Show_add(){
    Delete_page();
    document.querySelector(".contents_add").innerHTML = 
    `
    <h1>料理追加</h1>
    <p>料理名：</p><input type="text" name="add_meal_name" class="add_meal_name" placeholder="(例)ホイコーロー")>
    <p>メモ(任意)：</p><input type="text" name="add_meal_memo" class="add_meal_memo" placeholder="")>

    <fieldset>
        <legend>種類(必須)</legend>
        <label><input data-index="1" type="checkbox" name="add_kind">和食</label>
        <label><input data-index="2" type="checkbox" name="add_kind">洋食</label>
        <label><input data-index="3" type="checkbox" name="add_kind">中華</label>
    </fieldset>
    <fieldset>
        <legend>大変さ(必須)</legend>
        <label><input data-index="1" type="checkbox" name="add_difficulty" >簡単</label>
        <label><input data-index="2" type="checkbox" name="add_difficulty" >お手軽</label>
        <label><input data-index="3" type="checkbox" name="add_difficulty" >本格</label>
    </fieldset>
    <fieldset>
        <legend>特徴</legend>
        <label><input data-index="1" type="checkbox" name="add_feature" >軽め</label>
        <label><input data-index="2" type="checkbox" name="add_feature" >重め</label>
        <label><input data-index="3" type="checkbox" name="add_feature" >特別</label>
        <label><input data-index="4" type="checkbox" name="add_feature" >弁当にプラス</label>
        <label><input data-index="5" type="checkbox" name="add_feature" >明日も食べられる</label>
    </fieldset>
    <fieldset>
        <legend>\"使う\"材料</legend>
        <label><input data-index="1" type="checkbox" name="add_ingredient" >卵</label>
        <label><input data-index="2" type="checkbox" name="add_ingredient" >牛乳</label>
        <label><input data-index="3" type="checkbox" name="add_ingredient" >お米</label>
    </fieldset>
    <button class="add_meal">追加</button>
    `;

    document.querySelector(".add_meal").addEventListener("click",function(){
      let elems;
      Add_meal(-1,"default","memo",new Array(N_kind),new Array(N_difficulty),new Array(N_feature),new Array(N_ingredient));
      meals[meals.length-1].id = meals.length-1;
      let meal_name = document.querySelector(".add_meal_name").value;
      meals[meals.length-1].name = meal_name;
      let meal_memo = document.querySelector(".add_meal_memo").value;
      meals[meals.length-1].memo = meal_memo;
      elems = document.getElementsByName("add_kind");
      for(let i = 0; i < N_kind; i++){
        if(elems[i].checked) meals[meals.length-1].kind[i] = 1;
        else meals[meals.length-1].kind[i] = 0;
      }
      elems = document.getElementsByName("add_difficulty");
      for(let i = 0; i < N_difficulty; i++){
        if(elems[i].checked) meals[meals.length-1].difficulty[i] = 1;
        else meals[meals.length-1].difficulty[i] = 0;
      }
      elems = document.getElementsByName("add_feature");
      for(let i = 0; i < N_feature; i++){
        if(elems[i].checked) meals[meals.length-1].feature[i] = 1;
        else meals[meals.length-1].feature[i] = 0;
      }
      elems = document.getElementsByName("add_ingredient");
      for(let i = 0; i < N_ingredient; i++){
        if(elems[i].checked) meals[meals.length-1].ingredient[i] = 1;
        else meals[meals.length-1].ingredient[i] = 0;
      }
      alert("追加しました！");
      Show_add();
    });

  }

  function Show_index(){
    Delete_page();
    document.querySelector(".contents_index").innerHTML = 
    `
    <h1>料理一覧</h1>
    <p>現在登録されている料理</p>
    <div class="meal_index"></div>
    <ul>
    `;

    for(let i = 0; i < meals.length; i++){
      document.querySelector(".meal_index").innerHTML += "<li>" + meals[i].name;
      document.querySelector(".meal_index").innerHTML += `<button class="detail_${i}">詳細・編集</button> </li><br><br>`
    }

    document.querySelector(".meal_index").innerHTML += "</ul>";
  }

  function Show_help(){
    Delete_page();
  }

  function Delete_page(){
    document.querySelector(".contents_gacha").innerHTML = "";
    document.querySelector(".contents_history").innerHTML = "";
    document.querySelector(".contents_add").innerHTML = "";
    document.querySelector(".contents_index").innerHTML = "";
    document.querySelector(".contents_help").innerHTML = "";
  }

  function Delete_history(){
    localStorage.removeItem("results");
    let json = localStorage.getItem('results');
    results = JSON.parse(json);
    if(results == null) results = [];
    console.log(results);
  }
  

</script>
</html>